= Demo Using Custom Prometheus Metrics for OpenShift Autoscaling with KEDA
:ocp-ver: 4.11
:source-highlighter: rouge
:toc:[]

image:img/openshift-keda-autoscaling-sequence.png[]

Updated: {localdate}

.Outline of Steps
* Enable user workload monitoring
* Install "OpenShift Custom Metrics Autoscaler" operator and deploy KedaController
* Deploy application with custom metrics target and associated ServiceMonitor
* Create Thanos serviceaccount, token, role, rolebinding
* Configure authentication from Keda to Thanos
* Deploy sample application to autoscale
* Define deployment to scale and the metrics to trigger scaling with ScaledResource

.Docs and Refs
* https://docs.openshift.com/container-platform/{ocp-ver}/monitoring/enabling-monitoring-for-user-defined-projects.html[Enabling user workload monitoring]
* https://docs.openshift.com/container-platform/{ocp-ver}/nodes/pods/nodes-pods-autoscaling-custom.html
* https://access.redhat.com/articles/6718611[Autoscaling for RGW in ODF via HPA using KEDA]
* https://docs.openshift.com/container-platform/{ocp-ver}/monitoring/managing-metrics.html 
* https://github.com/rhobs/prometheus-example-app
* https://keda.sh/docs/2.8/scalers/prometheus/
* https://access.redhat.com/articles/6675491[Enabling TLS in ServiceMonitor]

== Prerequisites

=== Enable User Workload Monitoring

* https://docs.openshift.com/container-platform/{ocp-ver}/monitoring/enabling-monitoring-for-user-defined-projects.html[OpenShift user workload monitoring]

[source,bash]
----
oc extract configmap/cluster-monitoring-config \
   -n openshift-monitoring --to=-\
  | yq eval '.enableUserWorkload = true' - > config.yaml
oc set data configmap/cluster-monitoring-config \
  --from-file=config.yaml -n openshift-monitoring 
----

==== Granting non-admin users permission to monitor user-defined projects

.Roles
* `monitoring-rules-view` grants read access to PrometheusRule custom resources for a project.
* `monitoring-rules-edit` grants create, modify, and deleting PrometheusRule custom resources for a project.
* `monitoring-edit` grants `monitoring-rules-edit` plus create new scrape targets for services or pods. With this role, you can also create, modify, and delete ServiceMonitor and PodMonitor resources.

Grant `monitoring-edit` role.


include::operator/readme.adoc[leveloffset=+2]

include::custom-metric-app/readme.adoc[leveloffset=+1]

include::scaled-app/readme.adoc[leveloffset=+1]


== Managing metrics targets

Go to Observer -> Metrics -> promql query and search for "version" to see metric from link:custom-metric-app[custom metric app].

https://docs.openshift.com/container-platform/{ocp-ver}/monitoring/managing-metrics-targets.html

As admin Observe -> Targets -> filter to keda-test namespace. 

Target http://10.128.5.43:8080/metrics corresponds to endpoint of service prometheus-example-app
